{"version":3,"sources":["assets\\scr\\env\\HotUpdate.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["/*\r\n * @Author: saury\r\n * @Date: 2021-04-27 10:39:44\r\n * @Des: 热更\r\n * @Tips: \r\n */\r\n\r\nconst { ccclass, property, executeInEditMode } = cc._decorator;\r\n\r\n@ccclass\r\n@executeInEditMode //该脚本可以在编辑器中执行(有生命周期的)\r\nexport default class HotUpdate extends cc.Component {\r\n\r\n    @property(cc.Asset)\r\n    manifestUrl: cc.Asset = null;           // 热更比较文件\r\n\r\n    private versionCompareHandle = null;    // 版本比较函数\r\n    private _storagePath: string;\r\n    private _am = null;\r\n    private _updating = false;              // 是否在更新中\r\n    private _canRetry = false;              // 是否可以重新热更(热更失败了)\r\n    private _updateListener = null;         // ???\r\n    private customManifestStr: string;\r\n\r\n    onLoad() {\r\n        if (!cc.sys.isNative) { return; }\r\n\r\n        // project.manifest\r\n        this.customManifestStr = (this.manifestUrl as any)._nativeAsset;\r\n\r\n        //\r\n        this._storagePath = ((jsb.fileUtils ? jsb.fileUtils.getWritablePath() : '/') + 'blackjack-remote-asset');\r\n\r\n        // 重写版本比较函数\r\n        this.versionCompareHandle = function (versionA, versionB) {\r\n            cc.log(\"自定义比较版本: version A is \" + versionA + ', version B is ' + versionB);\r\n            let vA = versionA.split('.');\r\n            let vB = versionB.split('.');\r\n            for (let i = 0; i < vA.length; ++i) {\r\n                let a = parseInt(vA[i]);\r\n                let b = parseInt(vB[i] || 0);\r\n                if (a === b) {\r\n                    continue;\r\n                }\r\n                else {\r\n                    return a - b;\r\n                }\r\n            }\r\n            if (vB.length > vA.length) {\r\n                return -1;\r\n            }\r\n            else {\r\n                return 0;\r\n            }\r\n        };\r\n        // Init with empty manifest url for testing custom manifest\r\n        this._am = new jsb.AssetsManager('', this._storagePath, this.versionCompareHandle);\r\n\r\n        // 设置验证回调, 但我们还没有md5校验函数, 所以只有打印一些消息\r\n        // 验证通过返回true, 否则返回false\r\n        this._am.setVerifyCallback(function (path, asset) {\r\n            let compressed = asset.compressed;// When asset is compressed, we don't need to check its md5, because zip file have been deleted.\r\n            let expectedMD5 = asset.md5;    // 获取正确的md5值\r\n            let relativePath = asset.path;  // asset.path is relative path and path is absolute.\r\n            let size = asset.size;          // The size of asset file, but this value could be absent.\r\n            if (compressed) {\r\n                //console.log( \"Verification passed : \" + relativePath);\r\n                return true;\r\n            }\r\n            else {\r\n                //console.log( \"Verification passed:\" + relativePath + \"(\" + expectedMD5 + \")\");\r\n                return true;\r\n            }\r\n        });\r\n\r\n        if (cc.sys.os === cc.sys.OS_ANDROID) {\r\n            // Some Android device may slow down the download process when concurrent tasks is too much.\r\n            // The value may not be accurate, please do more test and find what's most suitable for your game.\r\n            this._am.setMaxConcurrentTask(2);\r\n        }\r\n\r\n        this.entrance();\r\n    }\r\n\r\n    \r\n    onDestroy() {\r\n        if (this._updateListener) {\r\n            this._am.setEventCallback(null);\r\n            this._updateListener = null;\r\n        }\r\n    }\r\n\r\n    // -----\r\n\r\n    /** 热更入口 */\r\n    entrance() {\r\n        this.checkUpdate();\r\n    }\r\n\r\n    /** 好像没有用到 */\r\n    loadCustomManifest() {\r\n        if (this._am.getState() === jsb.AssetsManager.State.UNINITED) {\r\n            let manifest = new jsb.Manifest(this.customManifestStr, this._storagePath);\r\n            this._am.loadLocalManifest(manifest, this._storagePath);\r\n            console.log('Using custom manifest');\r\n        }\r\n    }\r\n\r\n    /** 检查更新 - 回调 */\r\n    private checkCb(event) {\r\n        console.log('Code: ' + event.getEventCode());\r\n        switch (event.getEventCode()) {\r\n            case jsb.EventAssetsManager.ERROR_NO_LOCAL_MANIFEST:\r\n                console.log(\"未找到本地清单文件，已跳过热更新。\")\r\n                break;\r\n            case jsb.EventAssetsManager.ERROR_DOWNLOAD_MANIFEST:\r\n            case jsb.EventAssetsManager.ERROR_PARSE_MANIFEST:\r\n                console.log(\"无法下载清单文件，已跳过热更新。\")\r\n                break;\r\n            case jsb.EventAssetsManager.ALREADY_UP_TO_DATE:\r\n                console.log(\"已经是最新的远程版本。\")\r\n                break;\r\n            case jsb.EventAssetsManager.NEW_VERSION_FOUND:\r\n                console.log('新版本!!, please try to update. (' + this._am.getTotalBytes() + ')');\r\n                setTimeout(() => {\r\n                    this.hotUpdate();\r\n                }, 100);\r\n                break;\r\n            default:\r\n                return;\r\n        }\r\n\r\n        this._am.setEventCallback(null);\r\n        this._updating = false;\r\n    }\r\n\r\n    /** 检查更新 */\r\n    private checkUpdate() {\r\n        if (this._updating) {\r\n            console.log('检查更新中 ...');\r\n            return;\r\n        }\r\n        if (this._am.getState() === jsb.AssetsManager.State.UNINITED) {\r\n            let url = this.manifestUrl.nativeUrl;   // Resolve md5 url\r\n            console.log(\"新包的 manifestUrl-uuid :\", url);\r\n            this._am.loadLocalManifest(url);\r\n        }\r\n\r\n        console.log(this._am.getLocalManifest(), this._am.getLocalManifest().isLoaded())\r\n\r\n        if (!this._am.getLocalManifest() || !this._am.getLocalManifest().isLoaded()) {\r\n            console.log('未能加载本地清单...');\r\n            return;\r\n        }\r\n        this._am.setEventCallback(this.checkCb.bind(this));\r\n\r\n        this._am.checkUpdate();\r\n        this._updating = true;\r\n    }\r\n\r\n    /** 热更 - 回调  */\r\n    private updateCb(event) {\r\n        let needRestart = false;\r\n        let failed = false;\r\n        switch (event.getEventCode()) {\r\n            case jsb.EventAssetsManager.ERROR_NO_LOCAL_MANIFEST:\r\n                console.log('未找到本地清单文件，已跳过热更新。');\r\n                failed = true;\r\n                break;\r\n            case jsb.EventAssetsManager.UPDATE_PROGRESSION:\r\n                console.log(\"更新. 字节进度\", event.getDownloadedBytes() + ' / ' + event.getTotalBytes(), +\r\n                    \"文件进度:\", event.getDownloadedFiles() + ' / ' + event.getTotalFiles());\r\n\r\n                let msg = event.getMessage();\r\n                if (msg) {\r\n                    console.log('Updated file: ' + msg);\r\n                }\r\n                break;\r\n            case jsb.EventAssetsManager.ERROR_DOWNLOAD_MANIFEST:\r\n            case jsb.EventAssetsManager.ERROR_PARSE_MANIFEST:\r\n                console.log('无法下载清单文件，已跳过热更新。');\r\n                failed = true;\r\n                break;\r\n            case jsb.EventAssetsManager.ALREADY_UP_TO_DATE:\r\n                console.log('已经是最新的远程版本。');\r\n                failed = true;\r\n                break;\r\n            case jsb.EventAssetsManager.UPDATE_FINISHED:\r\n                console.log('更新完成。 ' + event.getMessage());\r\n                needRestart = true;\r\n                break;\r\n            case jsb.EventAssetsManager.UPDATE_FAILED:\r\n                console.log('更新失败。 ' + event.getMessage());\r\n                this._updating = false;\r\n                this._canRetry = true;\r\n                break;\r\n            case jsb.EventAssetsManager.ERROR_UPDATING:\r\n                console.log('资产更新错误： ' + event.getAssetId() + ', ' + event.getMessage());\r\n                break;\r\n            case jsb.EventAssetsManager.ERROR_DECOMPRESS:\r\n                console.log('错误解压缩');\r\n                console.log(event.getMessage());\r\n                break;\r\n            default:\r\n                break;\r\n        }\r\n\r\n        if (failed) {\r\n            this._am.setEventCallback(null);\r\n            this._updateListener = null;\r\n            this._updating = false;\r\n        }\r\n\r\n        if (needRestart) {\r\n            console.log(\"成功热更新\");\r\n            this._am.setEventCallback(null);\r\n            this._updateListener = null;\r\n\r\n            // Prepend the manifest's search path\r\n            let searchPaths = jsb.fileUtils.getSearchPaths();\r\n            let newPaths = this._am.getLocalManifest().getSearchPaths();\r\n            Array.prototype.unshift.apply(searchPaths, newPaths);\r\n\r\n            // This value will be retrieved and appended to the default search path during game startup,\r\n            // please refer to samples/js-tests/main.js for detailed usage.\r\n            // Re-add the search paths in main.js is very important, otherwise, new scripts won't take effect.\r\n            cc.sys.localStorage.setItem('HotUpdateSearchPaths', JSON.stringify(searchPaths));\r\n            jsb.fileUtils.setSearchPaths(searchPaths);\r\n\r\n            cc.audioEngine.stopAll();\r\n            cc.game.restart();\r\n        }\r\n    }\r\n\r\n    /** 热更 */\r\n    private hotUpdate() {\r\n        if (this._am && !this._updating) {\r\n            this._am.setEventCallback(this.updateCb.bind(this));\r\n\r\n            if (this._am.getState() === jsb.AssetsManager.State.UNINITED) {\r\n                // Resolve md5 url\r\n                let url = this.manifestUrl.nativeUrl;\r\n                // if (cc.loader.md5Pipe) {\r\n                //     url = cc.loader.md5Pipe.transformURL(url);\r\n                // }\r\n                console.log(\"hotUpdate loadLocalManifest:\", url);\r\n                this._am.loadLocalManifest(url);\r\n            }\r\n\r\n            this._am.update();\r\n            this._updating = true;\r\n            console.log(\"execute hotUpdate\");\r\n        }\r\n    }\r\n\r\n    /** 重试热更 */\r\n    retry() {\r\n        if (!this._updating && this._canRetry) {\r\n            this._canRetry = false;\r\n\r\n            console.log('Retry failed Assets...');\r\n            this._am.downloadFailedAssets();\r\n        }\r\n    }\r\n\r\n}\r\n"]}